{
  "name": "Web to Podcast Generator",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "GET",
        "path": "podcast",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "serve-html",
      "name": "Serve HTML Page",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [
        250,
        100
      ]
    },
    {
      "parameters": {
        "respondWith": "text",
        "responseBody": "=<!DOCTYPE html>\n<html lang=\"zh-CN\">\n<head>\n    <meta charset=\"UTF-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    <title>é—»é“ - ç½‘é¡µè½¬æ’­å®¢ç”Ÿæˆå™¨</title>\n    <style>\n        * { box-sizing: border-box; margin: 0; padding: 0; }\n        body { font-family: -apple-system, BlinkMacSystemFont, \"Segoe UI\", Roboto, sans-serif; background: #f5f5f5; min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px; }\n        .container { background: #fff; border-radius: 12px; box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1); padding: 40px; width: 100%; max-width: 500px; }\n        h1 { font-size: 24px; margin-bottom: 8px; color: #333; }\n        .subtitle { color: #666; margin-bottom: 24px; font-size: 14px; }\n        .input-group { display: flex; gap: 8px; margin-bottom: 20px; }\n        input[type=\"url\"] { flex: 1; padding: 12px 16px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; outline: none; transition: border-color 0.2s; }\n        input[type=\"url\"]:focus { border-color: #007aff; }\n        button { padding: 12px 24px; background: #007aff; color: #fff; border: none; border-radius: 8px; font-size: 14px; cursor: pointer; transition: background 0.2s; white-space: nowrap; }\n        button:hover { background: #0056b3; }\n        button:disabled { background: #ccc; cursor: not-allowed; }\n        .status { text-align: center; padding: 20px; color: #666; display: none; }\n        .status.show { display: block; }\n        .status.error { color: #d00; }\n        .spinner { width: 24px; height: 24px; border: 3px solid #eee; border-top-color: #007aff; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 12px; }\n        @keyframes spin { to { transform: rotate(360deg); } }\n        .player { display: none; margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee; }\n        .player.show { display: block; }\n        audio { width: 100%; margin-bottom: 12px; }\n        .download-btn { width: 100%; background: #34c759; }\n        .download-btn:hover { background: #2da44e; }\n    </style>\n</head>\n<body>\n    <div class=\"container\">\n        <h1>ğŸ™ï¸ é—»é“</h1>\n        <p class=\"subtitle\">è¾“å…¥æ–‡ç« é“¾æ¥ï¼Œä¸€é”®ç”Ÿæˆæ’­å®¢éŸ³é¢‘</p>\n        <div class=\"input-group\">\n            <input type=\"url\" id=\"url-input\" placeholder=\"https://example.com/article\" />\n            <button id=\"generate-btn\" onclick=\"generate()\">ç”Ÿæˆ</button>\n        </div>\n        <div class=\"status\" id=\"status\">\n            <div class=\"spinner\"></div>\n            <span id=\"status-text\">æ­£åœ¨ç”Ÿæˆï¼Œè¯·ç¨å€™...</span>\n        </div>\n        <div class=\"player\" id=\"player\">\n            <audio id=\"audio\" controls></audio>\n            <button class=\"download-btn\" onclick=\"download()\">ä¸‹è½½éŸ³é¢‘</button>\n        </div>\n    </div>\n    <script>\n        const WEBHOOK_URL = window.location.href;\n        let audioBlob = null;\n        let audioFilename = 'podcast.mp3';\n        async function generate() {\n            const urlInput = document.getElementById('url-input');\n            const btn = document.getElementById('generate-btn');\n            const status = document.getElementById('status');\n            const statusText = document.getElementById('status-text');\n            const player = document.getElementById('player');\n            const audio = document.getElementById('audio');\n            const url = urlInput.value.trim();\n            if (!url) { alert('è¯·è¾“å…¥æ–‡ç« é“¾æ¥'); return; }\n            btn.disabled = true;\n            player.classList.remove('show');\n            status.classList.remove('error');\n            status.classList.add('show');\n            statusText.textContent = 'æ­£åœ¨ç”Ÿæˆï¼Œçº¦éœ€ 1-2 åˆ†é’Ÿ...';\n            try {\n                const response = await fetch(WEBHOOK_URL, {\n                    method: 'POST',\n                    headers: { 'Content-Type': 'application/json' },\n                    body: JSON.stringify({ url })\n                });\n                if (!response.ok) { throw new Error('HTTP ' + response.status); }\n                const contentType = response.headers.get('Content-Type') || '';\n                if (contentType.includes('audio/')) {\n                    audioBlob = await response.blob();\n                    audioFilename = 'podcast_' + Date.now() + '.mp3';\n                } else {\n                    const result = await response.json();\n                    if (!result.success) { throw new Error(result.error || 'ç”Ÿæˆå¤±è´¥'); }\n                    if (result.audio_data) {\n                        const binaryStr = atob(result.audio_data);\n                        const bytes = new Uint8Array(binaryStr.length);\n                        for (let i = 0; i < binaryStr.length; i++) { bytes[i] = binaryStr.charCodeAt(i); }\n                        audioBlob = new Blob([bytes], { type: 'audio/mp3' });\n                        audioFilename = 'podcast_' + (result.timestamp || Date.now()) + '.mp3';\n                    } else { throw new Error('æœªè¿”å›éŸ³é¢‘æ•°æ®'); }\n                }\n                audio.src = URL.createObjectURL(audioBlob);\n                status.classList.remove('show');\n                player.classList.add('show');\n            } catch (err) {\n                status.classList.add('error');\n                statusText.textContent = 'é”™è¯¯: ' + err.message;\n                document.querySelector('.spinner').style.display = 'none';\n            } finally { btn.disabled = false; }\n        }\n        function download() {\n            if (!audioBlob) return;\n            const a = document.createElement('a');\n            a.href = URL.createObjectURL(audioBlob);\n            a.download = audioFilename;\n            a.click();\n        }\n        document.getElementById('url-input').addEventListener('keypress', (e) => { if (e.key === 'Enter') generate(); });\n    </script>\n</body>\n</html>",
        "options": {
          "responseHeaders": {
            "entries": [
              {
                "name": "Content-Type",
                "value": "text/html; charset=utf-8"
              }
            ]
          }
        }
      },
      "id": "respond-html",
      "name": "Respond HTML",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        450,
        100
      ]
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "podcast",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "webhook-trigger",
      "name": "Webhook Trigger",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [
        250,
        300
      ]
    },
    {
      "parameters": {
        "method": "GET",
        "url": "={{ $json.body.url }}",
        "authentication": "none",
        "options": {
          "timeout": 60000
        }
      },
      "id": "fetch-webpage",
      "name": "Fetch Webpage",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        450,
        300
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://ark.cn-beijing.volces.com/api/v3/chat/completions",
        "authentication": "none",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $env.DOUBAO_API_KEY }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ model: $env.DOUBAO_ENDPOINT_ID, messages: [{ role: 'system', content: 'ä½ æ˜¯ä¸€ä¸ªå†…å®¹è¿‡æ»¤ä¸“å®¶ã€‚è¯·ä»ä»¥ä¸‹ç½‘é¡µHTMLä¸­æå–ä¸»è¦æ–‡ç« å†…å®¹ï¼Œå»é™¤å¯¼èˆªã€å¹¿å‘Šã€é¡µè„šç­‰æ— å…³å†…å®¹ã€‚åªä¿ç•™æ–‡ç« çš„æ ‡é¢˜å’Œæ­£æ–‡ã€‚' }, { role: 'user', content: $json.data.substring(0, 8000) }] }) }}",
        "options": {
          "timeout": 120000
        }
      },
      "id": "filter-content",
      "name": "Filter Content (Doubao)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        650,
        300
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://ark.cn-beijing.volces.com/api/v3/chat/completions",
        "authentication": "none",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $env.DOUBAO_API_KEY }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ model: $env.DOUBAO_ENDPOINT_ID, messages: [{ role: 'system', content: 'ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ’­å®¢è„šæœ¬æ’°å†™ä¸“å®¶ã€‚è¯·å°†ä»¥ä¸‹æ–‡ç« å†…å®¹æ”¹å†™æˆé€‚åˆæ’­å®¢æœ—è¯»çš„è„šæœ¬ã€‚è¦æ±‚ï¼š1. ä½¿ç”¨å£è¯­åŒ–çš„è¡¨è¾¾ï¼›2. æ·»åŠ é€‚å½“çš„è¿‡æ¸¡è¯­ï¼›3. ä¿æŒå†…å®¹çš„å®Œæ•´æ€§å’Œå‡†ç¡®æ€§ï¼›4. æ§åˆ¶åœ¨3000å­—ä»¥å†…ã€‚' }, { role: 'user', content: $json.choices[0].message.content }], temperature: 0.8 }) }}",
        "options": {
          "timeout": 120000
        }
      },
      "id": "generate-script",
      "name": "Generate Script (Doubao)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        850,
        300
      ]
    },
    {
      "parameters": {
        "jsCode": "const text = $json.choices[0].message.content;\nconst MAX_CHUNK_SIZE = 300;\nfunction splitTextIntoChunks(text, maxSize) {\n  const chunks = [];\n  let remaining = text;\n  while (remaining.length > 0) {\n    if (remaining.length <= maxSize) {\n      chunks.push(remaining.trim());\n      break;\n    }\n    let splitPoint = maxSize;\n    const searchArea = remaining.substring(0, maxSize);\n    const lastPunct = Math.max(\n      searchArea.lastIndexOf('ã€‚'),\n      searchArea.lastIndexOf('ï¼'),\n      searchArea.lastIndexOf('ï¼Ÿ'),\n      searchArea.lastIndexOf('ï¼›'),\n      searchArea.lastIndexOf('ï¼Œ'),\n      searchArea.lastIndexOf('\\n')\n    );\n    if (lastPunct > maxSize * 0.5) {\n      splitPoint = lastPunct + 1;\n    }\n    chunks.push(remaining.substring(0, splitPoint).trim());\n    remaining = remaining.substring(splitPoint);\n  }\n  return chunks.filter(c => c.length > 0);\n}\nconst chunks = splitTextIntoChunks(text, MAX_CHUNK_SIZE);\nconst timestamp = Date.now();\nreturn chunks.map((chunk, index) => ({ json: { text: chunk, chunkIndex: index, totalChunks: chunks.length, timestamp: timestamp } }));"
      },
      "id": "split-text",
      "name": "Split Text into Chunks",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1050,
        300
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://openspeech.bytedance.com/api/v1/tts",
        "authentication": "none",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "x-api-key",
              "value": "={{ $env.DOUBAO_TTS_ACCESS_TOKEN }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ app: { cluster: 'volcano_tts' }, user: { uid: 'n8n-podcast' }, audio: { voice_type: 'BV001', encoding: 'mp3', speed_ratio: 1.0, volume_ratio: 1.0, pitch_ratio: 1.0 }, request: { reqid: String($json.timestamp) + '-' + String($json.chunkIndex), text: $json.text, operation: 'query' } }) }}",
        "options": {
          "timeout": 60000
        }
      },
      "id": "tts-synthesis",
      "name": "TTS Synthesis (Doubao)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        1250,
        300
      ]
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\nconst timestamp = items[0].json.timestamp || Date.now();\nconst sortedItems = items.sort((a, b) => a.json.chunkIndex - b.json.chunkIndex);\nconst audioChunks = [];\nlet totalSize = 0;\nfor (const item of sortedItems) {\n  if (item.json.data) {\n    audioChunks.push(item.json.data);\n    totalSize += item.json.data.length;\n  }\n}\nconst combinedBase64 = audioChunks.join('');\nreturn [{ json: { audio_data: combinedBase64, timestamp: timestamp, chunks: items.length, total_size: totalSize }, binary: { data: { data: combinedBase64, mimeType: 'audio/mp3', fileName: 'podcast_' + timestamp + '.mp3' } } }];"
      },
      "id": "merge-audio",
      "name": "Merge Audio Chunks",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1450,
        300
      ]
    },
    {
      "parameters": {
        "respondWith": "binary",
        "responseDataSource": "automatically"
      },
      "id": "respond-webhook",
      "name": "Respond to Webhook",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        1650,
        300
      ]
    }
  ],
  "connections": {
    "Serve HTML Page": {
      "main": [
        [
          {
            "node": "Respond HTML",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook Trigger": {
      "main": [
        [
          {
            "node": "Fetch Webpage",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch Webpage": {
      "main": [
        [
          {
            "node": "Filter Content (Doubao)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Filter Content (Doubao)": {
      "main": [
        [
          {
            "node": "Generate Script (Doubao)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generate Script (Doubao)": {
      "main": [
        [
          {
            "node": "Split Text into Chunks",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Split Text into Chunks": {
      "main": [
        [
          {
            "node": "TTS Synthesis (Doubao)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "TTS Synthesis (Doubao)": {
      "main": [
        [
          {
            "node": "Merge Audio Chunks",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge Audio Chunks": {
      "main": [
        [
          {
            "node": "Respond to Webhook",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  }
}
